create extension if not exists pg_trgm;
create extension if not exists pgcrypto;

-- Students
create table if not exists students (
  id uuid primary key default gen_random_uuid(),
  student_no text unique not null,
  cca_email text unique not null,
  last_name text not null,
  first_name text not null,
  second_name text,
  middle_initial text,
  school_year text check (school_year ~ '^[0-9]{4} - [0-9]{4}$'),
  program text not null,
  section text not null,
  password text not null,
  activation_code text not null,
  recovery_code text,
  active_status boolean not null default false,
  is_password_temp boolean not null default true
);

create index if not exists students_last_name_idx on students (last_name);
create index if not exists students_first_name_idx on students (first_name);
create index if not exists students_section_idx on students (section);
create index if not exists students_program_idx on students (program);
create index if not exists students_active_status_idx on students (active_status);
create index if not exists students_recovery_code_idx on students (recovery_code);

create index if not exists students_name_idx on students (last_name, first_name);

create index if not exists students_last_name_trgm_idx on students using gin (last_name gin_trgm_ops);
create index if not exists students_first_name_trgm_idx on students using gin (first_name gin_trgm_ops);
create index if not exists students_section_trgm_idx on students using gin (section gin_trgm_ops);
create index if not exists students_program_trgm_idx on students using gin (program gin_trgm_ops);
create index if not exists students_cca_email_trgm_idx on students using gin (cca_email gin_trgm_ops);
create index if not exists students_student_no_trgm_idx on students using gin (student_no gin_trgm_ops);
create index if not exists students_recovery_code_trgm_idx on students using gin (recovery_code gin_trgm_ops);

-- Ensure school_year exists for existing DBs
alter table students
  add column if not exists school_year text;

alter table students
  alter column school_year drop not null;

do $$
begin
  if not exists (
    select 1
    from pg_constraint
    where conname = 'students_school_year_format_chk'
      and conrelid = 'students'::regclass
  ) then
    alter table students
      add constraint students_school_year_format_chk
      check (school_year ~ '^[0-9]{4} - [0-9]{4}$');
  end if;
end $$;

-- Practicum Coordinators
create table if not exists practicum_coordinators (
  id uuid primary key default gen_random_uuid(),
  cca_email text unique not null,
  last_name text not null,
  first_name text not null,
  second_name text,
  password text not null,
  activation_code text not null,
  recovery_code text,
  active_status boolean not null default false,
  is_password_temp boolean not null default true
);

create index if not exists practicum_coordinators_last_name_idx on practicum_coordinators (last_name);
create index if not exists practicum_coordinators_first_name_idx on practicum_coordinators (first_name);
create index if not exists practicum_coordinators_active_status_idx on practicum_coordinators (active_status);
create index if not exists practicum_coordinators_recovery_code_idx on practicum_coordinators (recovery_code);

create index if not exists practicum_coordinators_name_idx on practicum_coordinators (last_name, first_name);

create index if not exists practicum_coordinators_last_name_trgm_idx on practicum_coordinators using gin (last_name gin_trgm_ops);
create index if not exists practicum_coordinators_first_name_trgm_idx on practicum_coordinators using gin (first_name gin_trgm_ops);
create index if not exists practicum_coordinators_cca_email_trgm_idx on practicum_coordinators using gin (cca_email gin_trgm_ops);
create index if not exists practicum_coordinators_recovery_code_trgm_idx on practicum_coordinators using gin (recovery_code gin_trgm_ops);

-- Practicum Instructors
create table if not exists practicum_instructors (
  id uuid primary key default gen_random_uuid(),
  cca_email text unique not null,
  last_name text not null,
  first_name text not null,
  second_name text,
  password text not null,
  activation_code text not null,
  recovery_code text,
  active_status boolean not null default false,
  is_password_temp boolean not null default true
);

create index if not exists practicum_instructors_last_name_idx on practicum_instructors (last_name);
create index if not exists practicum_instructors_first_name_idx on practicum_instructors (first_name);
create index if not exists practicum_instructors_active_status_idx on practicum_instructors (active_status);
create index if not exists practicum_instructors_recovery_code_idx on practicum_instructors (recovery_code);

create index if not exists practicum_instructors_name_idx on practicum_instructors (last_name, first_name);

create index if not exists practicum_instructors_last_name_trgm_idx on practicum_instructors using gin (last_name gin_trgm_ops);
create index if not exists practicum_instructors_first_name_trgm_idx on practicum_instructors using gin (first_name gin_trgm_ops);
create index if not exists practicum_instructors_cca_email_trgm_idx on practicum_instructors using gin (cca_email gin_trgm_ops);
create index if not exists practicum_instructors_recovery_code_trgm_idx on practicum_instructors using gin (recovery_code gin_trgm_ops);

-- Student Requirements
create table if not exists student_requirements (
  id uuid primary key default gen_random_uuid(),
  student_id uuid references students(id) on delete cascade,
  last_name text not null,
  first_name text not null,
  second_name text,
  middle_initial text,
  student_no text not null,
  section text not null,
  program text not null,
  school_year text check (school_year ~ '^[0-9]{4} - [0-9]{4}$'),
  practicum_application boolean not null default false,
  letter_of_intent boolean not null default false,
  endorsement_letter boolean not null default false,
  practicum_parental_consent boolean not null default false,
  acceptance_form boolean not null default false,
  reply_form boolean not null default false,
  practicum_training_agreement boolean not null default false,
  attendance_sheet boolean not null default false,
  weekly_journal boolean not null default false,
  transmittal_form boolean not null default false,
  evaluation_form boolean not null default false,
  outreach_program_design boolean not null default false,
  outreach_post_activity_report boolean not null default false,
  ojt_log_sheet boolean not null default false,
  requirements_checklist boolean not null default false,
  cca_hymn boolean not null default false
);

create index if not exists student_requirements_student_id_idx on student_requirements (student_id);
create index if not exists student_requirements_student_no_idx on student_requirements (student_no);

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ICSLIS OJT System | Handled Sections</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/staff_header.css' %}?v=2" />
  <style>
    :root {
      --ink: #0a0a0c;
      --paper: #f6f7f9;
      --accent: #0f2b52;
      --muted: #6e7278;
      --line: rgba(15, 43, 82, 0.08);
      --shadow: 0 22px 46px rgba(8, 9, 12, 0.14);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Work Sans", system-ui, -apple-system, sans-serif;
      color: var(--ink);
      background: radial-gradient(1200px 640px at 6% 8%, rgba(217, 182, 90, 0.26) 0%, transparent 55%),
                  radial-gradient(900px 700px at 92% 16%, rgba(15, 43, 82, 0.18) 0%, transparent 55%),
                  linear-gradient(155deg, #f6f7f9, #eef1f6 55%, #f8f9fb);
      min-height: 100vh;
    }

    .content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px 48px;
      display: grid;
      gap: 24px;
    }

    .hero {
      background: #ffffff;
      border-radius: 24px;
      padding: 32px;
      box-shadow: var(--shadow);
      border: 1px solid var(--line);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .hero h2 {
      margin: 0 0 12px;
      font-family: "Fraunces", serif;
      font-size: clamp(28px, 4vw, 36px);
      color: var(--accent);
    }

    .hero p {
      margin: 0;
      color: var(--muted);
      font-size: 16px;
      line-height: 1.5;
      max-width: 600px;
    }

    .card {
      background: #ffffff;
      border-radius: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--line);
      overflow: hidden;
    }

    .table-wrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    .sections-table {
      table-layout: fixed;
      min-width: 700px;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--line);
      font-size: 14px;
      vertical-align: middle;
    }

    th {
      color: var(--accent);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: #f8fafc;
      text-align: center;
      vertical-align: bottom;
    }

    #requirements_table td {
      text-align: center;
      padding: 12px 8px;
    }

    #students_table {
      table-layout: fixed;
      min-width: 760px;
    }

    #students_table th,
    #students_table td {
      text-align: left;
      white-space: nowrap;
    }

    #students_table th:nth-child(1),
    #students_table td:nth-child(1) { width: 22%; }
    #students_table th:nth-child(2),
    #students_table td:nth-child(2) { width: 48%; }
    #students_table th:nth-child(3),
    #students_table td:nth-child(3) { width: 30%; }

    #students_table td:nth-child(2),
    #students_table td:nth-child(3) {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #requirements_table {
      table-layout: fixed;
      min-width: 2000px;
    }

    #requirements_table td:nth-child(1),
    #requirements_table td:nth-child(2) {
      text-align: left;
    }

    /* Keep student number/name fixed and single-line in requirements */
    #requirements_table th:nth-child(1),
    #requirements_table td:nth-child(1) {
      width: 90px;
      white-space: nowrap;
    }

    #requirements_table th:nth-child(2),
    #requirements_table td:nth-child(2) {
      width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Keep Weekly Journal columns aligned and readable */
    #weekly_table {
      table-layout: fixed;
      min-width: 980px;
    }

    #weekly_table th,
    #weekly_table td {
      text-align: center;
      white-space: nowrap;
    }

    #weekly_table th:nth-child(1),
    #weekly_table td:nth-child(1) { width: 14%; }
    #weekly_table th:nth-child(2),
    #weekly_table td:nth-child(2) { width: 18%; }
    #weekly_table th:nth-child(3),
    #weekly_table td:nth-child(3) { width: 22%; }
    #weekly_table th:nth-child(4),
    #weekly_table td:nth-child(4) { width: 16%; }
    #weekly_table th:nth-child(5),
    #weekly_table td:nth-child(5) { width: 30%; }

    #weekly_table td:nth-child(5) {
      text-align: left;
      white-space: normal;
      word-break: break-word;
    }

    /* Keep DTR month columns aligned */
    #dtr_table {
      table-layout: fixed;
      min-width: 1080px;
    }

    #dtr_table th,
    #dtr_table td {
      text-align: center;
      white-space: nowrap;
    }

    #dtr_table th:nth-child(1),
    #dtr_table td:nth-child(1) {
      width: 14%;
      text-align: left;
    }

    #dtr_table th:nth-child(2),
    #dtr_table td:nth-child(2) {
      width: 24%;
      text-align: left;
      white-space: normal;
      word-break: break-word;
    }

    tbody tr {
      transition: background 0.15s ease;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .empty {
      padding: 48px 24px;
      color: var(--muted);
      text-align: center;
      font-size: 15px;
      background: #fcfcfd;
    }

    .btn-view {
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      border-radius: 10px;
      padding: 10px 18px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(15, 43, 82, 0.15);
    }

    .btn-view:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(15, 43, 82, 0.25);
      background: #163c6e;
    }

    .sections-table th.col-section,
    .sections-table td.col-section {
      width: 35%;
      text-align: left;
    }

    .sections-table th.col-school-year,
    .sections-table td.col-school-year {
      width: 30%;
      text-align: center;
    }

    .sections-table th.col-action,
    .sections-table td.col-action {
      width: 35%;
      text-align: center;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(10, 10, 12, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 20px;
      backdrop-filter: blur(4px);
      transition: opacity 0.2s ease;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      width: min(1300px, 100%);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      animation: modalSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes modalSlideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-head {
      background: #ffffff;
      border-bottom: 1px solid var(--line);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-shrink: 0;
    }

    .modal-title {
      margin: 0;
      font-family: "Fraunces", serif;
      font-size: 22px;
      color: var(--accent);
    }

    .modal-close {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 24px;
      width: 32px;
      height: 32px;
      display: grid;
      place-items: center;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #f1f5f9;
      color: var(--ink);
    }

    .modal-body {
      padding: 0;
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    .tab-row {
      display: flex;
      gap: 24px;
      padding: 0 24px;
      border-bottom: 1px solid var(--line);
      background: #fff;
      flex-shrink: 0;
      overflow-x: auto;
    }

    .tab-btn {
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--muted);
      padding: 16px 4px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .tab-btn:hover {
      color: var(--accent);
    }

    .tab-btn.active {
      color: var(--accent);
      border-color: var(--accent);
    }

    .tab-panel {
      display: none;
      padding: 0;
      flex: 1;
      overflow: hidden; 
      /* Let the table-wrap handle scrolling */
    }

    .tab-panel.active {
      display: flex;
      flex-direction: column;
    }
    
    .tab-panel .table-wrap {
      flex: 1;
      overflow: auto;
      padding-bottom: 24px;
    }
    
    /* Ensure tables inside tabs fit well */
    .tab-panel table {
      border-top: none;
    }
    .tab-panel th {
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 1px 0 var(--line);
    }

    .mark-ok,
    .mark-no {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .mark-ok {
      color: #0f6b2f;
      background: rgba(20, 120, 57, 0.12);
    }

    .mark-no {
      color: #8e1d1d;
      background: rgba(161, 35, 35, 0.12);
    }

    @media (max-width: 900px) {
      .content { padding: 22px; }
    }

    @media (max-width: 600px) {
      .content { padding: 16px; }
    }
  </style>
</head>
<body>
  {% include "partials/staff_header.html" %}
  {% include "partials/staff_sidebar.html" %}

  <main class="content">
    <section class="hero">
      <h2>Handled Sections</h2>
      <p>Sections currently assigned to you for supervision.</p>
    </section>

    <section class="card">
      {% if assigned_sections %}
      <div class="table-wrap">
        <table class="sections-table">
          <thead>
            <tr>
              <th class="col-section">Section</th>
              <th class="col-school-year">School Year</th>
              <th class="col-action">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for row in assigned_sections %}
            <tr>
              <td class="col-section">{{ row.section }}</td>
              <td class="col-school-year">{{ row.school_year }}</td>
              <td class="col-action">
                <button
                  class="btn-view"
                  type="button"
                  data-section-id="{{ row.section_id }}"
                >
                  View Section
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty">No section assignment found.</div>
      {% endif %}
    </section>
  </main>

  <div class="modal-backdrop" id="section_modal_backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="section_modal_title">
      <div class="modal-head">
        <h3 class="modal-title" id="section_modal_title">Section Details</h3>
        <button class="modal-close" type="button" id="section_modal_close" aria-label="Close details">&times;</button>
      </div>
      <div class="modal-body">
        <div class="tab-row">
          <button class="tab-btn active" data-tab="students" type="button">Students</button>
          <button class="tab-btn" data-tab="requirements" type="button">Requirements</button>
          <button class="tab-btn" data-tab="weekly" type="button">Weekly Journal</button>
          <button class="tab-btn" data-tab="dtr" type="button">Attendance Sheet (DTR)</button>
        </div>

        <div class="tab-panel active" data-panel="students">
          <div class="table-wrap"><table id="students_table"></table></div>
        </div>
        <div class="tab-panel" data-panel="requirements">
          <div class="table-wrap"><table id="requirements_table"></table></div>
        </div>
        <div class="tab-panel" data-panel="weekly">
          <div class="table-wrap"><table id="weekly_table"></table></div>
        </div>
        <div class="tab-panel" data-panel="dtr">
          <div class="table-wrap"><table id="dtr_table"></table></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const navBtn = document.querySelector('.nav-btn');
      const closeBtn = document.querySelector('.close-btn');
      const backdrop = document.querySelector('.sidebar-backdrop');
      const body = document.body;
      const detailsBaseUrl = "{% url 'instructor_sections' %}";
      let activeSectionId = null;
      let modalRefreshTimer = null;

      function openSidebar() {
        body.classList.add('sidebar-open');
      }

      function closeSidebar() {
        body.classList.remove('sidebar-open');
      }

      if (navBtn) {
        navBtn.addEventListener('click', openSidebar);
      }

      if (closeBtn) {
        closeBtn.addEventListener('click', closeSidebar);
      }

      if (backdrop) {
        backdrop.addEventListener('click', closeSidebar);
      }

      const modalBackdrop = document.getElementById('section_modal_backdrop');
      const modalClose = document.getElementById('section_modal_close');
      const modalTitle = document.getElementById('section_modal_title');

      function setTableHtml(tableId, headers, rowsHtml) {
        const table = document.getElementById(tableId);
        table.innerHTML = `
          <thead>
            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
          </thead>
          <tbody>${rowsHtml || `<tr><td colspan="${headers.length}">No records found.</td></tr>`}</tbody>
        `;
      }

      function markCell(value) {
        return value
          ? '<span class="mark-ok" title="Completed">&#10003;</span>'
          : '<span class="mark-no" title="Not completed">&#10007;</span>';
      }

      function renderSectionModalData(data) {
        if (!data) return;

        modalTitle.textContent = `Section ${data.section} (${data.school_year})`;

        const studentRows = (data.students || []).map((s) => `
          <tr>
            <td>${s.student_no || ""}</td>
            <td>${s.name || ""}</td>
            <td>${s.program || ""}</td>
          </tr>
        `).join("");
        setTableHtml("students_table", ["Student Number", "Student", "Program"], studentRows);

        const reqRows = (data.requirements || []).map((r) => `
          <tr>
            <td>${r.student_no || ""}</td>
            <td>${r.name || ""}</td>
            <td>${markCell(r.practicum_application)}</td>
            <td>${markCell(r.letter_of_intent)}</td>
            <td>${markCell(r.endorsement_letter)}</td>
            <td>${markCell(r.practicum_parental_consent)}</td>
            <td>${markCell(r.acceptance_form)}</td>
            <td>${markCell(r.reply_form)}</td>
            <td>${markCell(r.practicum_training_agreement)}</td>
            <td>${markCell(r.attendance_sheet)}</td>
            <td>${markCell(r.weekly_journal)}</td>
            <td>${markCell(r.transmittal_form)}</td>
            <td>${markCell(r.evaluation_form)}</td>
            <td>${markCell(r.outreach_program_design)}</td>
            <td>${markCell(r.outreach_post_activity_report)}</td>
            <td>${markCell(r.ojt_log_sheet)}</td>
            <td>${markCell(r.requirements_checklist)}</td>
            <td>${markCell(r.cca_hymn)}</td>
          </tr>
        `).join("");
        setTableHtml(
          "requirements_table",
          [
            "Student Number",
            "Student",
            "Form&nbsp;1<br>Practicum<br>Application",
            "Form&nbsp;2<br>Letter of<br>Intent",
            "Form&nbsp;3<br>Endorsement<br>Letter",
            "Form&nbsp;4<br>Practicum<br>Parental<br>Consent",
            "Form&nbsp;5<br>Acceptance<br>Form",
            "Form&nbsp;6<br>Reply<br>Form",
            "Form&nbsp;7<br>Practicum<br>Training<br>Agreement",
            "Form&nbsp;8<br>Attendance<br>Sheet",
            "Form&nbsp;9<br>Weekly<br>Journal",
            "Form&nbsp;10<br>Transmittal<br>Form",
            "Form&nbsp;11<br>Evaluation<br>Form",
            "Form&nbsp;12<br>Outreach<br>Program<br>Design",
            "Form&nbsp;13<br>Outreach<br>Post-Activity<br>Report",
            "Form&nbsp;14<br>OJT<br>Log<br>Sheet",
            "Form&nbsp;15<br>Requirements<br>Check<br>List",
            "Final Requirement<br>CCA Hymn"
          ],
          reqRows
        );

        const weeklyRows = (data.weekly_journal || []).map((w) => `
          <tr>
            <td>Week ${w.week_no || ""}</td>
            <td>${w.due_date || ""}</td>
            <td>${w.submitted_at || ""}</td>
            <td>${w.status || ""}</td>
            <td>${w.status_note || ""}</td>
          </tr>
        `).join("");
        setTableHtml("weekly_table", ["Week", "Due Date", "Submitted At", "Status", "Notes"], weeklyRows);

        const dtrRows = (data.dtr || []).map((d) => `
          <tr>
            <td>${d.student_no || ""}</td>
            <td>${d.name || ""}</td>
            <td>${d.january_hours ?? 0}</td>
            <td>${d.february_hours ?? 0}</td>
            <td>${d.march_hours ?? 0}</td>
            <td>${d.april_hours ?? 0}</td>
            <td>${d.may_hours ?? 0}</td>
            <td>${d.june_hours ?? 0}</td>
            <td>${d.total_hours ?? 0}</td>
          </tr>
        `).join("");
        setTableHtml(
          "dtr_table",
          ["Student Number", "Student", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Total"],
          dtrRows
        );

      }

      function getDetailsUrl(sectionId) {
        return `${detailsBaseUrl}${sectionId}/details/`;
      }

      async function fetchSectionData(sectionId) {
        const response = await fetch(getDetailsUrl(sectionId), {
          method: 'GET',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          credentials: 'same-origin',
          cache: 'no-store',
        });
        if (!response.ok) {
          throw new Error(`Unable to refresh section data (${response.status}).`);
        }
        const payload = await response.json();
        if (!payload.ok || !payload.data) {
          throw new Error(payload.error || "No section data returned.");
        }
        return payload.data;
      }

      async function refreshOpenModal() {
        if (!activeSectionId || !modalBackdrop.classList.contains('show')) return;
        try {
          const data = await fetchSectionData(activeSectionId);
          renderSectionModalData(data);
        } catch (_err) {
          // Keep current data visible if refresh fails.
        }
      }

      async function openSectionModal(sectionId) {
        if (!sectionId) return;
        activeSectionId = sectionId;
        try {
          const data = await fetchSectionData(sectionId);
          renderSectionModalData(data);
          modalBackdrop.classList.add('show');
          body.classList.remove('sidebar-open');

          if (modalRefreshTimer) clearInterval(modalRefreshTimer);
          modalRefreshTimer = setInterval(refreshOpenModal, 10000);
        } catch (err) {
          alert(err.message || "Failed to load section details.");
        }
      }

      function closeModal() {
        modalBackdrop.classList.remove('show');
        activeSectionId = null;
        if (modalRefreshTimer) {
          clearInterval(modalRefreshTimer);
          modalRefreshTimer = null;
        }
      }

      document.querySelectorAll('.btn-view').forEach((btn) => {
        btn.addEventListener('click', function() {
          const sectionId = this.getAttribute('data-section-id');
          openSectionModal(sectionId);
        });
      });

      if (modalClose) modalClose.addEventListener('click', closeModal);
      if (modalBackdrop) {
        modalBackdrop.addEventListener('click', function(e) {
          if (e.target === modalBackdrop) closeModal();
        });
      }

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modalBackdrop && modalBackdrop.classList.contains('show')) {
          closeModal();
        }
      });

      document.querySelectorAll('.tab-btn').forEach((btn) => {
        btn.addEventListener('click', function() {
          const tab = this.getAttribute('data-tab');
          document.querySelectorAll('.tab-btn').forEach((b) => b.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach((p) => p.classList.remove('active'));
          this.classList.add('active');
          const panel = document.querySelector(`.tab-panel[data-panel="${tab}"]`);
          if (panel) panel.classList.add('active');
        });
      });
    });
  </script>
</body>
</html>
